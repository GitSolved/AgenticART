%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#1a1a2e', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4a4a6a', 'lineColor': '#4a9eff', 'secondaryColor': '#16213e', 'tertiaryColor': '#0f3460'}}}%%

flowchart TB
    subgraph USER["USER INTERFACE"]
        WebUI["Web UI<br/>(Streamlit)"]
        CLI["CLI Tools"]
    end

    subgraph AGENT["AGENT LAYER (Engine)"]
        direction TB

        subgraph CHAIN["Attack Chain Orchestration"]
            Planner["Planner<br/>Strategy & Phase Selection"]
            Generator["Script Generator<br/>NL to Executable Code"]
            Summarizer["Summarizer<br/>Output Analysis"]
        end

        subgraph PROMPTS["Prompt Templates"]
            P1["reconnaissance.md"]
            P2["exploitation.md"]
            P3["verification.md"]
        end

        Planner --> Generator
        Generator --> Summarizer
        Summarizer -.->|"retry"| Planner
    end

    subgraph LLM["LLM PROVIDERS"]
        Ollama["Ollama<br/>(Local)"]
        OpenAI["OpenAI<br/>(API)"]
        Anthropic["Anthropic<br/>(API)"]
    end

    subgraph CORE["CORE MODULES"]
        direction TB

        subgraph RECON["Reconnaissance"]
            ADB["ADB Connection"]
            DevEnum["Device Enumeration"]
            SvcDisc["Service Discovery"]
        end

        subgraph SCAN["Scanning"]
            VulnScan["Vulnerability Scanner"]
            CVEMatch["CVE Matcher"]
            PermAnalyze["Permission Analyzer"]
        end

        subgraph EXPLOIT["Exploitation"]
            Runner["Exploit Runner"]
            Magisk["Magisk Root"]
            Kernel["Kernel Exploits"]
            ADBExp["ADB Exploits"]
        end

        subgraph VERIFY["Verification"]
            RootCheck["Root Check"]
            CapTest["Capability Test"]
        end
    end

    subgraph TARGET["TARGET DEVICE"]
        Genymotion["Genymotion Emulator<br/>Android 14 / SM-S911B"]
    end

    USER --> AGENT
    AGENT --> LLM
    AGENT --> CORE
    CORE <-->|"ADB TCP/6555"| TARGET

    classDef engine fill:#4a9eff,stroke:#fff,stroke-width:2px,color:#000
    classDef framework fill:#1a1a2e,stroke:#4a4a6a,stroke-width:1px
    classDef target fill:#2e7d32,stroke:#fff,stroke-width:2px

    class Planner,Generator,Summarizer,CVEMatch,Kernel engine
    class WebUI,CLI,ADB,Runner framework
    class Genymotion target
