"""
Bootloader Unlock Techniques

Guides for unlocking bootloaders on various Android devices.
Bootloader unlock is often required for persistent root access.
"""

import logging
from dataclasses import dataclass
from enum import Enum

from ...reconnaissance import ADBConnection

logger = logging.getLogger(__name__)


class UnlockMethod(Enum):
    OEM_UNLOCK = "oem_unlock"          # Standard OEM unlock
    FASTBOOT_UNLOCK = "fastboot"       # Fastboot flashing unlock
    MANUFACTURER_TOOL = "mfr_tool"     # Manufacturer unlock tool
    EXPLOIT_BASED = "exploit"          # Exploit-based unlock
    NOT_SUPPORTED = "not_supported"    # Cannot be unlocked


class DeviceManufacturer(Enum):
    GOOGLE = "google"
    SAMSUNG = "samsung"
    XIAOMI = "xiaomi"
    ONEPLUS = "oneplus"
    MOTOROLA = "motorola"
    LG = "lg"
    HUAWEI = "huawei"
    SONY = "sony"
    NOKIA = "nokia"
    ASUS = "asus"
    UNKNOWN = "unknown"


@dataclass
class BootloaderStatus:
    """Bootloader status information."""
    manufacturer: DeviceManufacturer
    model: str
    is_unlocked: bool
    can_unlock: bool
    unlock_method: UnlockMethod
    unlock_steps: list[str]
    warnings: list[str]


@dataclass
class UnlockResult:
    """Result of bootloader unlock attempt."""
    success: bool
    message: str
    requires_manual_steps: bool
    manual_steps: list[str]


class BootloaderUnlocker:
    """
    Bootloader unlock module.

    Provides:
    - Bootloader status detection
    - Manufacturer-specific unlock guidance
    - OEM unlock preparation
    - Fastboot unlock commands
    """

    def __init__(self, adb: ADBConnection):
        self.adb = adb

    def detect_manufacturer(self) -> DeviceManufacturer:
        """Detect device manufacturer."""
        manufacturer = self.adb.get_prop("ro.product.manufacturer").lower()
        brand = self.adb.get_prop("ro.product.brand").lower()

        manufacturer_map = {
            "google": DeviceManufacturer.GOOGLE,
            "samsung": DeviceManufacturer.SAMSUNG,
            "xiaomi": DeviceManufacturer.XIAOMI,
            "oneplus": DeviceManufacturer.ONEPLUS,
            "motorola": DeviceManufacturer.MOTOROLA,
            "lg": DeviceManufacturer.LG,
            "huawei": DeviceManufacturer.HUAWEI,
            "sony": DeviceManufacturer.SONY,
            "hmd global": DeviceManufacturer.NOKIA,
            "nokia": DeviceManufacturer.NOKIA,
            "asus": DeviceManufacturer.ASUS,
        }

        for key, value in manufacturer_map.items():
            if key in manufacturer or key in brand:
                return value

        return DeviceManufacturer.UNKNOWN

    def get_bootloader_status(self) -> BootloaderStatus:
        """Get comprehensive bootloader status."""
        manufacturer = self.detect_manufacturer()
        model = self.adb.get_prop("ro.product.model")

        # Check if already unlocked
        is_unlocked = self._check_unlocked()

        # Check if OEM unlock is enabled
        oem_unlock_allowed = self._check_oem_unlock_allowed()

        # Determine unlock method and steps based on manufacturer
        unlock_method, unlock_steps, warnings = self._get_unlock_info(
            manufacturer, oem_unlock_allowed
        )

        return BootloaderStatus(
            manufacturer=manufacturer,
            model=model,
            is_unlocked=is_unlocked,
            can_unlock=oem_unlock_allowed or is_unlocked,
            unlock_method=unlock_method,
            unlock_steps=unlock_steps,
            warnings=warnings,
        )

    def _check_unlocked(self) -> bool:
        """Check if bootloader is unlocked."""
        # Check various properties
        locked = self.adb.get_prop("ro.boot.flash.locked")
        if locked == "0":
            return True

        verified_boot = self.adb.get_prop("ro.boot.verifiedbootstate")
        if verified_boot == "orange":
            return True

        secure = self.adb.get_prop("ro.boot.secureboot")
        if secure == "0":
            return True

        return False

    def _check_oem_unlock_allowed(self) -> bool:
        """Check if OEM unlock is enabled in developer options."""
        # Different props for different Android versions
        props = [
            "sys.oem_unlock_allowed",
            "ro.oem_unlock_supported",
        ]

        for prop in props:
            value = self.adb.get_prop(prop)
            if value == "1":
                return True

        # Try to query settings
        setting = self.adb.shell("settings get global oem_unlock_allowed 2>/dev/null")
        return setting.strip() == "1"

    def _get_unlock_info(
        self,
        manufacturer: DeviceManufacturer,
        oem_unlock_allowed: bool,
    ) -> tuple[UnlockMethod, list[str], list[str]]:
        """Get manufacturer-specific unlock information."""

        warnings = [
            "WARNING: Unlocking bootloader will WIPE ALL DATA",
            "WARNING: This may void your warranty",
            "WARNING: Some features (Samsung Pay, Netflix HD) may stop working",
        ]

        if manufacturer == DeviceManufacturer.GOOGLE:
            return (
                UnlockMethod.FASTBOOT_UNLOCK,
                [
                    "1. Enable Developer Options (Settings > About > Tap Build Number 7x)",
                    "2. Enable OEM Unlocking in Developer Options",
                    "3. Reboot to bootloader: adb reboot bootloader",
                    "4. Unlock bootloader: fastboot flashing unlock",
                    "5. Confirm unlock on device (use volume buttons)",
                    "6. Device will factory reset and reboot",
                ],
                warnings,
            )

        elif manufacturer == DeviceManufacturer.SAMSUNG:
            return (
                UnlockMethod.OEM_UNLOCK,
                [
                    "1. Enable Developer Options",
                    "2. Enable OEM Unlock (may require Samsung account)",
                    "3. Wait 7 days (Samsung's unlock delay)",
                    "4. Reboot to Download mode: Power + Vol Down + USB",
                    "5. Use Odin or Heimdall to flash unlock",
                    "NOTE: Knox will be tripped permanently (0x1)",
                ],
                warnings + ["WARNING: Knox warranty void bit will be set permanently"],
            )

        elif manufacturer == DeviceManufacturer.XIAOMI:
            return (
                UnlockMethod.MANUFACTURER_TOOL,
                [
                    "1. Create Mi account and add phone number",
                    "2. Enable Developer Options and Mi Unlock status",
                    "3. Wait 168-720 hours (7-30 days) for unlock eligibility",
                    "4. Download Mi Unlock Tool from Xiaomi",
                    "5. Boot to fastboot mode: Power + Vol Down",
                    "6. Connect to PC and run Mi Unlock Tool",
                ],
                warnings + ["WARNING: Requires waiting period of up to 30 days"],
            )

        elif manufacturer == DeviceManufacturer.ONEPLUS:
            return (
                UnlockMethod.FASTBOOT_UNLOCK,
                [
                    "1. Enable Developer Options",
                    "2. Enable OEM Unlocking",
                    "3. Reboot to bootloader: adb reboot bootloader",
                    "4. Unlock bootloader: fastboot oem unlock",
                    "5. Confirm on device",
                ],
                warnings,
            )

        elif manufacturer == DeviceManufacturer.MOTOROLA:
            return (
                UnlockMethod.MANUFACTURER_TOOL,
                [
                    "1. Get unlock code from Motorola website",
                    "2. Sign in with Motorola account",
                    "3. Get device ID: fastboot oem get_unlock_data",
                    "4. Submit ID to Motorola for unlock key",
                    "5. Apply key: fastboot oem unlock <key>",
                ],
                warnings + ["WARNING: Requires Motorola account and code request"],
            )

        elif manufacturer == DeviceManufacturer.HUAWEI:
            return (
                UnlockMethod.NOT_SUPPORTED,
                [
                    "Huawei stopped providing bootloader unlock codes in 2018.",
                    "Options:",
                    "1. Use paid third-party unlock services (DC-Unlocker)",
                    "2. Use testpoint method (hardware modification)",
                    "3. Some older devices may have exploit-based unlocks",
                ],
                warnings + ["WARNING: Official unlock not available"],
            )

        else:
            return (
                UnlockMethod.FASTBOOT_UNLOCK if oem_unlock_allowed else UnlockMethod.NOT_SUPPORTED,
                [
                    "1. Enable Developer Options",
                    "2. Enable OEM Unlocking (if available)",
                    "3. Reboot to bootloader",
                    "4. Try: fastboot flashing unlock",
                    "5. Or try: fastboot oem unlock",
                    "Consult XDA Developers for device-specific instructions",
                ],
                warnings,
            )

    def prepare_unlock(self) -> UnlockResult:
        """Prepare device for bootloader unlock."""
        status = self.get_bootloader_status()

        if status.is_unlocked:
            return UnlockResult(
                success=True,
                message="Bootloader is already unlocked",
                requires_manual_steps=False,
                manual_steps=[],
            )

        if not status.can_unlock:
            return UnlockResult(
                success=False,
                message="OEM unlock is not enabled. Enable it in Developer Options first.",
                requires_manual_steps=True,
                manual_steps=[
                    "1. Go to Settings > About Phone",
                    "2. Tap Build Number 7 times to enable Developer Options",
                    "3. Go to Settings > Developer Options",
                    "4. Enable 'OEM Unlocking'",
                ],
            )

        # Reboot to bootloader
        logger.info("Rebooting to bootloader mode...")
        self.adb.execute("reboot bootloader")

        return UnlockResult(
            success=True,
            message="Device rebooting to bootloader. Follow manufacturer steps to complete unlock.",
            requires_manual_steps=True,
            manual_steps=status.unlock_steps,
        )

    def generate_unlock_script(self) -> str:
        """Generate bootloader unlock script."""
        status = self.get_bootloader_status()

        script = f'''#!/bin/bash
# Bootloader Unlock Script for {status.model}
# Manufacturer: {status.manufacturer.value}
# Generated by AgenticART

set -e

echo "╔══════════════════════════════════════════════════════════╗"
echo "║           BOOTLOADER UNLOCK SCRIPT                       ║"
echo "║  Device: {status.model:<43} ║"
echo "╚══════════════════════════════════════════════════════════╝"
echo ""

# Warnings
echo "⚠️  WARNING: This will WIPE ALL DATA on the device!"
echo "⚠️  WARNING: This may void your warranty!"
echo ""
read -p "Are you sure you want to continue? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo "Aborted."
    exit 1
fi

'''

        if status.is_unlocked:
            script += '''
echo "✓ Bootloader is already unlocked!"
exit 0
'''
        elif status.unlock_method == UnlockMethod.FASTBOOT_UNLOCK:
            script += '''
echo "[*] Checking for device in fastboot mode..."
if ! fastboot devices | grep -q "fastboot"; then
    echo "[*] Rebooting device to bootloader..."
    adb reboot bootloader
    sleep 5
fi

echo "[*] Attempting fastboot unlock..."
fastboot flashing unlock || fastboot oem unlock

echo "[*] Please confirm unlock on device using volume buttons"
echo "[*] Device will factory reset after unlock"
'''
        elif status.unlock_method == UnlockMethod.MANUFACTURER_TOOL:
            script += '''
echo "This device requires manufacturer unlock tool."
echo ""
echo "Steps:"
'''
            for step in status.unlock_steps:
                script += f'echo "  {step}"\n'

        script += '''
echo ""
echo "Unlock process initiated. Check device screen for confirmation."
'''

        return script

    def generate_report(self) -> str:
        """Generate bootloader status report."""
        status = self.get_bootloader_status()

        lines = [
            "=" * 60,
            "BOOTLOADER STATUS REPORT",
            "=" * 60,
            f"Manufacturer: {status.manufacturer.value.upper()}",
            f"Model: {status.model}",
            f"Bootloader Status: {'UNLOCKED ✓' if status.is_unlocked else 'LOCKED ✗'}",
            f"OEM Unlock Allowed: {'Yes' if status.can_unlock else 'No'}",
            f"Unlock Method: {status.unlock_method.value}",
            "",
            "UNLOCK PROCEDURE",
            "-" * 60,
        ]

        for step in status.unlock_steps:
            lines.append(f"  {step}")

        if status.warnings:
            lines.append("")
            lines.append("WARNINGS")
            lines.append("-" * 60)
            for warning in status.warnings:
                lines.append(f"  {warning}")

        lines.append("=" * 60)

        return "\n".join(lines)
